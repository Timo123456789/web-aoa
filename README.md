# Web AOA

## Configuration

There are a few environment variables (see `.env`) that can be set to configure the services dynamically.

| Variable                    | Default                | Description                                                              |
| --------------------------- | ---------------------- | ------------------------------------------------------------------------ |
| `NODE_ENV`                  | `dev`                  | Please use `production` for the use in production.                       |
| `HAPROXY_PORT`              | `80`                   | Bind services to a port.                                                 |
| `HAPROXY_CONFIG`            | `local`                | See Haproxy configs in /ops/haproxy.                                     |
| `HAPROXY_CERT`              | `-`                    | Path to the the certificate file which is used by Haproxy.               |
| `API_URL`                   | `http://localhost/api` | Used by the frontend and Swagger.                                        |
| `API_COMMAND`               | `start`                | Npm commands. Please use `start:prod` in production.                     |
| `MONGODB_CONNECTION_STRING` | `-`                    | For the API.                                                             |
| `JWT_SECRET`                | `-`                    | The secret for the JWT tokens which are generated by the API.            |
| `API_KEY`                   | `-`                    | Specifies the `X-API-KEY` for the API which is required to manage users. |
| `MAX_UPLOAD_FILE_SIZE_MB`   | `10`                   | Max upload file size (e.g. \*.rds files).                                |

The following environment variables are required for the first start. It's not possible to change these values afterwards.

| Variable                     | Default | Description            |
| ---------------------------- | ------- | ---------------------- |
| `MONGO_INITDB_ROOT_USERNAME` | `-`     | MongoDB root username. |
| `MONGO_INITDB_ROOT_PASSWORD` | `-`     | MongoDB root password. |
| `MONGO_INITDB_DATABASE`      | `-`     | Database name.         |
| `MONGO_INITDB_API_USERNAME`  | `-`     | MongoDB API username.  |
| `MONGO_INITDB_API_PASSWORD`  | `-`     | MongoDB API password.  |

> Please make sure you're using the right credentials (`MONGO_INITDB_API_*`) for `MONGODB_CONNECTION_STRING`.

## Development

```sh
docker-compose up
```

Or add the build flag to make sure, that everything is up to date.

```sh
docker-compose up --build
```

> All changes in `src` will be reloaded after the code (file) is changed. No need to restart the docker container.

## Production

All relevant commands will be run with the following build command. For more information see the `Makefile`.

```sh
make prod-pull-run
```

> Please use the `.env` for your `.env.production` and change the credentials!
> For more information about the environment variables see the section [Configuration](#configuration).

### Prepare certificate for Haproxy

```
sudo cat "/etc/letsencrypt/live/domain.com/fullchain.pem" \
    "/etc/letsencrypt/live/domain.com/privkey.pem" > "/etc/ssl/domain.com.pem"
```

The path `/etc/ssl/domain.com.pem` should be mounted via `HAPROXY_CERT`.
